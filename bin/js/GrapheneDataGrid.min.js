function GrapheneDataGrid(t){this.version="0.0.2",this.eventBus=new gform.eventBus({owner:"table",item:"model"},this),this.on=this.eventBus.on,this.dispatch=this.eventBus.dispatch,"object"==typeof(t=$.extend(!0,{filter:!0,sort:!0,search:!0,download:!0,upload:!0,columns:!0,id:gform.getUID()},t)).events&&t.events.length?t.events=_.map(t.events,function(t){return $.extend(!0,{global:!1},t)}):t.events=!1;var e=!1;if(window.localStorage&&t.name)try{e=JSON.parse(localStorage.getItem("bt_"+t.name))}catch(t){}t.item_template?t.item_template=GrapheneDataGrid.renderString(t.item_template):window.outerWidth>767||0==window.outerWidth?t.item_template=templates.table_row:t.item_template=templates.mobile_row,this.filterValues={},this.draw=function(){_.each(this.summary.items,function(t){this.$el.find(".filter #"+t.id+",[data-sort="+t.id+"]").toggle(t.isEnabled)}.bind(this)),t.search=this.filterValues,_.each(t.search,function(e,i){e||0===e||delete t.search[i]});var e=t.pagebuffer||2;this.$el.find('[name="search"]').length&&this.$el.find('[name="search"]').val().length?this.searchAll(this.$el.find('[name="search"]').val()):this.search(t);var i={};t.pagecount=Math.ceil(this.lastGrabbed/t.count),i.pages=[],t.page>t.pagecount&&(t.page=t.pagecount||1);var s=this.lastGrabbed>t.count*t.page?t.count*t.page:this.lastGrabbed,a=$('<tbody class="list-group">'),o=GrapheneDataGrid.renderString(t.item_template,n);_.each(this.grab(t),function(t){new viewitem({model:t,container:a,view:o})}),this.$el.find(".list-group").empty().replaceWith(a);var r=t.page-e;r<1&&(r=1);var l=t.page+e;l>t.pagecount&&(l=t.pagecount);for(var d=r;d<=l;d++){var h={name:d};t.page==d&&(h.active="active"),i.pages.push(h)}i.size=this.lastGrabbed,i.last=s,i.first=t.count*(t.page-1)+1,i.multiPage=l>r,i.isFirst=1==t.page,i.isLast=t.page==t.pagecount,i.showLast=t.pagecount==l,i.showFirst=1==r,i.checked_count=this.getSelected().length,i.entries=_.map(t.entries,function(e){return{value:e,selected:e==t.count}},t),this.renderObj=i,this.updateCount(),this.$el.find(".paginate-footer").html(GrapheneDataGrid.render("table_footer",this.renderObj)),this.fixStyle(),window.localStorage&&t.name&&localStorage.setItem("bt_"+t.name,JSON.stringify(this.state.get()))};var i=function(e){e.stopPropagation(),e.preventDefault(),"inc"==$(e.currentTarget).data("page")?(t.page++,t.page>t.pagecount&&(t.page=t.pagecount)):"dec"==$(e.currentTarget).data("page")?(t.page--,t.page<1&&(t.page=1)):t.page=$(e.currentTarget).data("page")||t.pagecount,this.draw()},s=function(e,i){if(1==e)this.$el.find(".reverse, [data-sort]").removeClass("text-primary").find("i").attr("class","fa fa-sort text-muted"),this.$el.find(".sortBy").val("true"),t.reverse=!1;else{void 0===i?t.sort==e?t.reverse=!t.reverse:t.reverse=!1:t.reverse=i;var s=this.$el.find(".reverse, [data-sort="+_.find(this.options.filterFields,{search:e}).id+"]");void 0!==s&&(t.reverse?s.find("i").attr("class","fa fa-sort-asc"):s.find("i").attr("class","fa fa-sort-desc"),s.siblings("[data-sort]").removeClass("text-primary"),s.siblings("[data-sort]").find("i").attr("class","fa fa-sort text-muted"),s.addClass("text-primary"))}t.sort=e}.bind(this);t=$.extend({count:t.count||25,page:1,sort:"createdAt",reverse:!1},t);self=this,void 0!==t.filters&&(t.filters=_.map(t.filters,function(t){t.type=t.type||"text";var e=_.assignIn({name:(gform.renderString(t.label)||"").toLowerCase().split(" ").join("_"),id:gform.getUID(),label:t.legend||t.name,validate:[],valid:!0,parsable:!0,visible:!0,enabled:!0,array:!1,offset:0},this.opts,gform.default,(gform.types[t.type]||gform.types.text).defaults,t);return""==e.name&&(e.name=e.id),e.item=t,e})),t.filterFields=_.map($.extend(!0,{},t.filters||t.schema),function(t){switch(t=gform.normalizeField.call({options:{default:{type:"text"}}},t),name=t.name,t.value="",t.type){case"checkbox":t.options=[{label:"False",value:"false"},{label:t.options[0]||"True",value:t.options[1]||"true"}];case"radio":t.type="select";case"select":t.placeholder=!1,t.options=[{type:"optgroup",options:[{label:"No Filter",value:null}],format:{label:"{{label}}"}},{type:"optgroup",options:t.options}];break;case"hidden":break;default:t.type="text"}return t.options&&"object"==typeof t.options&&(t.options=_.map(t.options,function(t){return"object"==typeof t?_.omit(t,"selected"):t})),t.id=t.id||gform.getUID(),t.search=t.name,t.name=t.id,t.show={},t.enabled=!0,t.help="",t}),"object"==typeof t.columns&&(t.filterFields=_.filter(t.filterFields,function(e){return _.includes(t.columns,e.name)||_.includes(t.columns,e.id)}));var a,n={start:"{{",end:"}}",checked_count:0,multi_checked:!1,multiEdit:!!t.multiEdit,items:_.map(t.filterFields,function(e){var i=e.search||e.label.split(" ").join("_").toLowerCase();if(e.template)i=e.template.replace(/{{value}}/gi,"{{attributes."+i+"}}");else switch(e.type){case"date":i='<span data-moment="{{attributes.'+i+'}}" data-format="L"></span>';break;case"select":i=t.inlineEdit?'<span data-popins="'+i+'"></span>':"{{display."+i+"}}";break;case"color":i='<div class="btn btn-default" style="background-color:{{attributes.'+i+'}}">{{attributes.'+i+"}}</div> {{attributes."+i+"}}";break;default:i=t.inlineEdit?'<span data-popins="'+i+'"></span>':"{{attributes."+i+"}}"}return{isEnabled:void 0===e.showColumn||e.showColumn,label:e.label,name:i,cname:e.name||e.label.split(" ").join("_").toLowerCase(),id:e.id,visible:!("hidden"==e.type)}})};function o(e,i){var s,a,n=this.files;window.FileReader?(s=n[0],(a=new FileReader).readAsText(s),a.onload=function(i){var s=i.target.result,a=CSVToArray(s),n=!0;$("#myModal").remove();var o=$(templates.modal.render({title:"Importing CSV ",footer:'<div class="btn btn-danger" data-dismiss="modal">Cancel</div>',body:'<div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100" style="width: 0%"><span class="sr-only">50% Complete</span></div></div><div class="status">Validating Items...</div>'}));o.modal(),o.on("hidden.bs.modal",function(){this.importing=!1}.bind(this));var r=a.length-1,l=2*r,d=[];this.importing=!0,a[0]=_.map(a[0],function(e){var i=_.find(t.schema,{label:e});return i=null==i?e:i.name});for(var h=1;h<a.length;h++){if(!this.importing)return!1;if(a[0].length==a[h].length){var c={};for(var f in a[0])c[a[0][f]]=a[h][f];if(!(n=e.validate(c)))break;d.push(n)}else r--;o.find(".progress-bar").width(h/l*100+"%")}if(!n)return o.find(".btn").html("Done"),void o.find(".status").html('<div class="alert alert-danger">Error(s) in row '+h+", failed to validate!<ul><li>"+_.filter(e.errors,function(t){return t.length}).join("</li><li>")+"</li></div>");for(o.find(".status").html("Adding Items..."),h=0;h<d.length;h++){if(!this.importing)return!1;e.add(d[h],{draw:!1}),o.find(".progress-bar").width((h+r)/l*100+"%")}o.find(".status").html('<div class="alert alert-success">Successfully processed file, '+r+" rows were added!</div>"),o.find(".btn").toggleClass("btn-danger btn-success").html("Done"),o.find(".progress").hide(),void 0!==e.options.defaultSort&&(e.models=_.sortBy(e.models,function(t){return t.attributes[this.options.defaultSort]}.bind(e)).reverse()),"function"==typeof e.options.onBulkLoad&&e.options.onBulkLoad()},a.onerror=function(t){"NotReadableError"==t.target.error.name&&alert("Canno't read file !")},i.currentTarget.value=""):alert("FileReader is not supported in this browser."),e.draw()}t.hasActions=!!(t.edit||t.delete||t.events),void 0===t.hasEdit&&(t.hasEdit=!!t.edit),void 0===t.hasDelete&&(t.hasDelete=!!t.delete),t.entries=t.entries||[25,50,100],n.options=t,n.showAdd=!!t.add||t.showAdd,this.defaults={},_.map(t.filterFields,function(t){switch(t.type){case"text":t.value="";break;case"checkbox":t.value="false";case"radio":t.value="";case"select":t.value=""}this.defaults[t.name]=t.value}.bind(this)),this.summary=n,a=t.template?a=GrapheneDataGrid.renderString(t.template,n):window.outerWidth>767||0==window.outerWidth?GrapheneDataGrid.render("table",n):GrapheneDataGrid.render("mobile_table",n),this.validate=function(e){var i=!1,s=new gform({fields:t.schema,attributes:e});return s.validate()?i=s.toJSON():(this.errors=s.errors,console.log("Model not valid")),s.destroy(),i},this.add=function(e,i){var s=new tableModel(this,e).on("check",function(){this.owner.updateCount()});if(!1!==i.validate)var a=new gform({fields:t.schema,model:s});return 0==i.validate||a.validate()?(this.models.push(s),void 0!==this.options.defaultSort&&(this.models=_.sortBy(this.models,function(t){return t.attributes[this.options.defaultSort]}.bind(this)).reverse()),!1!==i.draw&&this.draw(),!0!==i.silent&&this.dispatch("added",s),void 0!==a&&a.destroy(),s):(console.log("Model not valid"),!1)},this.search=function(t){var e=_.sortBy(this.getModels(),function(e){return e.attributes[t.sort]});t.reverse||(e=e.reverse()),filterMap=this.filterMap,e=_.filter(e,function(e){var i=$.isEmptyObject(t.search);for(var s in t.search){if(!(i=_.filter(t.filterFields,{id:s})[0]&&void 0===_.filter(t.filterFields,{id:s})[0].options?$.score((e.display[this.filterMap[s]]+"").replace(/\s+/g," ").toLowerCase(),(t.search[s]+"").toLowerCase())>.4:e.display[this.filterMap[s]]+""==t.search[s]+""||e.attributes[this.filterMap[s]]+""==t.search[s]+""))break}return i}),this.lastGrabbed=e.length,this.filtered=e},this.find=function(t){var e=_.keys(t);return _.filter(this.getModels(),function(i){return _.isEqual(t,_.pick(i.attributes,e))})},this.searchAll=function(e){t.sort=null,this.$el.find("[data-sort]").removeClass("text-primary"),this.$el.find("[data-sort]").find("i").attr("class","fa fa-sort text-muted"),this.filter&&this.filter.set(),e=e.toLowerCase(),_.map(this.getModels(),function(i){for(var s in i.score=0,t.filterFields)i.score+=$.score((i.display[t.filterFields[s].search]+"").replace(/\s+/g," ").toLowerCase(),e)}),this.filtered=_.filter(_.sortBy(this.getModels(),"score"),function(t){return t.score>0}).reverse(),this.lastGrabbed=this.filtered.length},this.fixStyle=function(){if(this.options.autoSize)try{var t=this.$el.find(".table-container > div"),e=this.$el.find(".table-container > table tr th:visible"),i=this.$el.find(".list-group-row th");this.$el.find(".table-container table").removeClass("table-fixed"),t.css("width","auto"),t.css("minWidth","auto"),e.css("width","auto"),e.css("minWidth","85px"),this.$el.find(".table-container > table tr th.select-column").css("minWidth","60px"),this.$el.find(".table-container > table tr th.select-column").css("width","60px"),i.css("width","auto"),i.css("minWidth","auto"),t.css("height",$(window).height()-t.offset().top-(88+this.options.autoSize)+"px"),_.each(i,function(t,i){void 0!==e[i]?(t.style.display="table-cell",e[i].offsetWidth>t.offsetWidth?($(t).css("width",e[i].offsetWidth+"px"),$(t).css("minWidth",e[i].offsetWidth+"px"),$(e[i]).css("width",e[i].offsetWidth+"px"),$(e[i]).css("minWidth",e[i].offsetWidth+"px")):($(e[i]).css("width",e[i].offsetWidth+"px"),$(e[i]).css("minWidth",e[i].offsetWidth+"px"),$(t).css("width",e[i].offsetWidth+"px"),$(t).css("minWidth",e[i].offsetWidth+"px"))):t.style.display="none"}.bind(this)),this.$el.find(".table-container table").addClass("table-fixed");var s=this.$el.find(".table-container > div table")[0].offsetWidth;this.$el.find(".table-container > table")[0].offsetWidth>s&&(s=this.$el.find(".table-container > table")[0].offsetWidth),t.css("width",s+"px"),t.css("minWidth",s+"px"),s>this.$el.find(".table-container")[0].offsetWidth?this.$el.find(".table-container").css("overflow","auto"):this.$el.find(".table-container").css("overflow","hidden")}catch(t){}},this.grab=function(t){return this.filtered.slice(t.count*(t.page-1),t.count*(t.page-1)+t.count)},this.getModels=function(){return _.filter(this.models,{deleted:!1})},this.getSelected=function(){return _.filter(this.models,{checked:!0,deleted:!1})},this.editCommon=function(){if(void 0!==this.options.multiEdit&&0!=this.options.multiEdit.length){var t=this.getSelected();if(0!=t.length){var e=_.map(t,function(t){return t.attributes}),i=_.filter(this.options.multiEdit,function(t){return 1==_.uniq(_.map(e,t)).length});if(0==i.length)$(templates.modal.render({title:"Common Field Editor ",footer:'<div class="btn btn-danger" data-dismiss="modal">Done</div>',body:'<div class="alert alert-warning">No eligible fields have been found for editing.</div>'})).modal();else{var s=_.filter(this.options.schema,function(t){return i.indexOf(t.name)>=0});new gform({legend:"("+t.length+") Common Field Editor",actions:[{type:"cancel"},{type:"save"}],fields:s,data:$.extend(!0,{},_.pick(t[0].attributes,i))}).on("save",function(e){var i=e.form.get();_.map(t,function(t){t.set($.extend(!0,{},t.attributes,i))}),e.form.pub("close")}).on("close",function(){this.draw(),"function"==typeof this.options.editComplete&&this.options.editComplete(this.getSelected(),this),this.dispatch("")}.bind(this)).on("cancel",function(t){t.form.pub("close")}).modal()}}}},this.destroy=function(){this.$el.find(".list-group").empty(),this.$el.off(),this.$el.empty()},this.state={get:function(){var e={count:this.options.count,page:this.options.page};return this.$el.find('[name="search"]').length&&this.$el.find('[name="search"]').val().length?e.search=this.$el.find('[name="search"]').val():(e.sort=t.sort,e.reverse=t.reverse,void 0!==this.filter&&(e.filters={},_.each(this.options.filterFields,function(t){e.filters[t.search]=this[t.id]}.bind(this.filter.toJSON())))),e.columns=_.map(_.map(_.filter(this.summary.items,function(t){return t.isEnabled}),"id"),function(t){return _.find(this.options.filterFields,{id:t}).search}.bind(this)),e}.bind(this),set:function(e){void 0!==e.columns&&e.columns.length&&(this.summary.items=_.map(this.summary.items,function(t){return t.isEnabled=_.includes(e.columns,this.filterMap[t.cname]),t}),this.$el.find('.columnEnables [type="checkbox"]').each(function(t){this.checked=!1}),t.columns&&_.each(e.columns,function(t){var e=this.$el.find('.columnEnables [data-field="'+_.find(this.options.filterFields,{search:t}).id+'"] [type="checkbox"]');e.length&&(e[0].checked=!0)}.bind(this))),void 0!==e.filters&&(this.filterValues={},_.each(e.filters,function(t,e){}.bind(this))),void 0!==e.sort&&s(e.sort||t.sort,e.reverse),void 0!==this.filter&&this.filter.set(this.filterValues),void 0!==e.search&&""!==e.search&&this.$el.find('[name="search"]').val(e.search),this.options.page=e.page||this.options.page,this.options.count=e.count||this.options.count,this.draw()}.bind(this)},this.models=[],this.options=t,this.filterMap={},_.map(t.filterFields,function(t){this.filterMap[t.id]=t.search}.bind(this));$(t.container).html(function(){return GrapheneDataGrid.renderString(a,n)}.call(this)),function(e){if(this.$el=e,this.options.columns&&this.$el.on("click",".columnEnables label",function(t){t.stopPropagation(),_.find(this.summary.items,{id:t.currentTarget.dataset.field}).isEnabled=t.currentTarget.childNodes[0].checked,this.draw()}.bind(this)),this.$el.on("change",".csvFileInput",_.partial(o,this)),this.$el.on("change",".sortBy",function(t){""!==$(t.currentTarget).val()&&(s((_.find(this.options.filterFields,{id:$(t.currentTarget).val()})||{search:!0}).search),this.draw())}.bind(this)),this.$el.on("click",".reverse",function(t){s(this.options.sort),this.draw()}.bind(this)),this.$el.on("click",".filterForm",function(e){this.$el.find('[name="search"]').val(""),new gform({legend:"Filter By",name:"modal_filter"+this.options.id,attributes:this.filterValues,disableMath:!0,suppress:!0,fields:t.filterFields}).on("save",function(){this.filterValues=gform.instances["modal_filter"+this.options.id].toJSON(),this.draw(),gform.instances["modal_filter"+this.options.id].trigger("close")}.bind(this)).modal()}.bind(this)),this.$el.on("click",'[name="bt-upload"]',function(){this.$el.find(".csvFileInput").click()}.bind(this)),this.$el.on("click",'[data-event="delete_all"]',function(t){var e=this.getSelected();e.length&&confirm("Are you sure you want to delete "+e.length+" records? \nThis operation can not be undone.\n\n")&&(_.each(e,function(t){"function"==typeof this.options.delete&&this.options.delete(t),t.delete()}.bind(this)),this.draw())}.bind(this)),this.$el.on("click","[data-event].custom-event",function(t){t.stopPropagation();var e=this.getSelected();e.length?_.each(e,function(t,e){this.dispatch(t,e)}.bind(this,t.target.dataset.event)):this.dispatch(t.target.dataset.event)}.bind(this)),this.$el.on("click",'[data-event="edit_all"]',function(t){t.stopPropagation(),void 0!==this.options.multiEdit&&0!==this.options.multiEdit.length&&this.getSelected().length>1?this.editCommon():new gform($.extend(!0,{},{name:"modal",actions:[{type:"cancel"},{type:"save"}],legend:'<i class="fa fa-pencil-square-o"></i> Edit',data:this.getSelected()[0].attributes,fields:this.getSelected()[0].schema},this.options.gform||{})).on("save",function(t){this.getSelected()[0].set(t.form.toJSON()),"function"==typeof this.options.edit&&this.options.edit(this.getSelected()[0]),"function"==typeof this.options.editComplete&&this.options.editComplete(this.getSelected(),this),this.draw(),t.form.pub("close")}.bind(this)).on("cancel",function(t){t.form.pub("close")}).modal()}.bind(this)),this.$el.on("change",'[name="count"]',function(e){t.count=parseInt($(e.currentTarget).val(),10),this.draw()}.bind(this)),this.$el.on("input",'[name="search"]',_.debounce(function(t){this.draw()}.bind(this),300)),e.find(".filter").length&&(this.filter=new gform({name:"filter"+this.options.id,clear:!1,fields:t.filterFields,default:{hideLabel:!0,type:"text",format:{label:"{{label}}",value:"{{value}}"}}},".filter").on("change",function(){this.$el.find('[name="search"]').val(""),this.filterValues=this.filter.toJSON(),this.draw()}.bind(this)),this.filter.set()),this.updateCount=function(t){t=t||this.getSelected().length,this.summary.checked_count=t,this.summary.multi_checked=t>1,this.$el.find('[name="events"]').html(GrapheneDataGrid.render("events",this.summary)),this.$el.find('[name="count"]').html(GrapheneDataGrid.render("count",this.summary));var e=this.$el.find('[data-event="select_all"].fa');t>0&&t==this.getModels().length?e.attr("class","fa fa-2x fa-check-square-o"):0==t?e.attr("class","fa fa-2x fa-square-o"):e.attr("class","fa fa-2x fa-minus-square-o")},this.$el.on("click",'[data-event="select_all"]',function(t){var e=this.getSelected();e.length||0==this.getModels().length?_.each(e,function(t){t.toggle(!1,!0)}):_.each(this.filtered,function(t){t.toggle(!0,!0)}),this.draw()}.bind(this)),t.data)for(var a in t.data)this.models.push(new tableModel(this,t.data[a]).on("check",function(t){t.model.owner.updateCount(),t.model.owner.draw()}));void 0!==this.options.defaultSort&&(this.models=_.sortBy(this.models,function(t){return t.attributes[this.options.defaultSort]}.bind(this)).reverse()),this.$el.on("click","[data-page]",i.bind(this)),t.sort&&this.$el.on("click","[data-sort]",function(t){t.stopPropagation(),t.preventDefault();var e=_.find(this.options.filterFields,{name:$(t.currentTarget).data("sort")}).search;this.options.reverse&&this.options.sort==e?s(!0):s(e),this.draw()}.bind(this)),this.$el.on("click",'[name="reset-search"]',function(){this.$el.find('[name="search"]').val(""),s(!0),this.filter&&this.filter.set(),this.filterValues={},this.draw()}.bind(this)),this.$el.on("click",'[name="bt-download"]',function(){this.getCSV()}.bind(this)),this.$el.find('[data-event="add"]').on("click",function(){var e=_.find(this.options.events,{name:"add"});void 0!==e&&"function"==typeof e.callback?e.callback.call(this):new gform($.extend(!0,{},{name:"modal",table:this,actions:[{type:"cancel"},{type:"save"}],legend:'<i class="fa fa-pencil-square-o"></i> Create New',fields:t.schema},t.gform||{})).on("save",function(t){t.form.validate()&&(this.add(t.form.get(),{validate:!1}),t.form.pub("close"))}.bind(this)).on("cancel",function(t){t.form.pub("close")}).modal()}.bind(this)),this.draw()}.call(this,$(t.container)),this.getCSV=function(t){var e=this.filterMap;csvify(_.map(this.filtered,function(t){return t.attributes}),_.map(_.filter(this.summary.items,function(t){return t.isEnabled}),function(t){return{label:t.label,name:e[t.cname]}}),t||this.options.title)},this.$el.find('[name="search"]').focus(),this.$el.find(".table-container > div").css("overflow","auto"),$(window).on("resize orientationChange",this.fixStyle.bind(this)),e&&this.state.set(e)}GrapheneDataGrid.render=function(t,e){return gform.m(templates[t||"row"]||templates.row,_.extend({},templates,e))},GrapheneDataGrid.renderString=function(t,e){return gform.m(t,_.extend({},templates,e))};
function CSVToArray(e,n){n=n||",";for(var t=new RegExp("(\\"+n+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+n+"\\r\\n]*))","gi"),r=[[]],a=null;a=t.exec(e);){var l,i=a[1];i.length&&i!==n&&r.push([]),l=a[2]?a[2].replace(new RegExp('""',"g"),'"'):a[3],r[r.length-1].push(l)}return r}!function(e){e.score=function(n,t,r){if(r=r||0,0===t.length)return.9;if(t.length>n.length)return 0;for(var a=t.length;a>0;a--){var l=t.substring(0,a),i=n.indexOf(l);if(!(i<0)&&!(i+t.length>n.length+r)){var s=n.substring(i+l.length),h=null;h=a>=t.length?"":t.substring(a);var o=e.score(s,h,r+i);if(o>0){var u=n.length-s.length;if(0!==i){var c=n.charCodeAt(i-1);if(32==c||9==c)for(var g=i-2;g>=0;g--)u-=32==(c=n.charCodeAt(g))||9==c?1:.15;else u-=i}return u+=o*s.length,u/=n.length}}}return 0}}(jQuery),csvify=function(e,n,t){var r='"'+_.map(n,"label").join('","')+'"\n';this.labels=_.map(n,"name");var a=_.zipObject(this.labels,_.map(this.labels,function(){return""}));r+=_.map(e,function(e){return JSON.stringify(_.values(_.extend(a,_.pick(e,this.labels))))},this).join("\n").replace(/(^\[)|(\]$)/gm,"").split('"').join("");var l=document.createElement("a");l.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(r)),l.setAttribute("download",(t||"GrapheneDataGrid")+".csv"),document.body.appendChild(l),l.click(),document.body.removeChild(l)};
function tableModel(t,i){this.owner=t,this.id=gform.getUID(),this.attributes={},this.display={},this.attribute_history=[],this.schema=t.options.schema;var e=function(){_.each(this.schema,function(t){if(void 0!==t.options){var i;if(void 0!==t.value_key)if("index"==t.value_key)i=t.options[this.attributes[t.name]];else{var e={};e[t.value_key]=this.attributes[t.name],i=_.find(t.options,e),$.isNumeric(this.attributes[t.name])&&(e[t.value_key]=parseInt(this.attributes[t.name]),void 0===i&&(i=_.find(t.options,e)),void 0===i&&(i=_.find(t.options,e)))}else void 0===(i=_.find(t.options,{value:this.attributes[t.name]}))&&(i=_.find(t.options,{id:this.attributes[t.name]})),$.isNumeric(this.attributes[t.name])&&(void 0===i&&(i=_.find(t.options,{value:parseInt(this.attributes[t.name],10)})),void 0===i&&(i=_.find(t.options,{id:parseInt(this.attributes[t.name],10)})));this.display[t.name]="object"==typeof i?i[t.label_key]||i.label||i.name:this.attributes[t.name]}else t.template?this.display[t.name]=GrapheneDataGrid.renderString(t.template):this.display[t.name]=this.attributes[t.name]}.bind(this))};this.set=function(t){this.attribute_history.push($.extend(!0,{},this.attributes)),this.attributes=t,e.call(this)},this.pat=function(){e.call(this)},this.checked=!1,this.deleted=!1,this.toggle=function(t,i){this.checked="bool"==typeof t?t:!this.checked,i||this.dispatch("check")},this.set(i),e.call(this),this.toJSON=function(){return this.attributes},this.undo=function(){this.deleted?(this.deleted=!1,this.owner.draw()):this.attribute_history.length&&(this.attributes=this.attribute_history.pop(),e.call(this),this.owner.draw())},this.delete=function(){this.deleted=!0},this.eventBus=new gform.eventBus({owner:"model",item:"model"},this),this.on=this.eventBus.on,this.dispatch=this.eventBus.dispatch}
function viewitem(t){this.update=function(){void 0!==this.gform&&this.gform.destroy(),this.$el.find("[data-event]").off(),this.$el.off(),void 0!==this.model.owner.options.preDraw&&this.model.owner.options.preDraw(this.model),this.$el.replaceWith(this.setElement(GrapheneDataGrid.renderString(t.view,this.model)).$el),this.$el.find("[data-popins]").length>0&&(this.gform=this.$el.gform({popins:{container:"#first",viewport:{selector:"body",padding:20}},renderer:"popins",model:this.model})),"function"==typeof this.model.owner.options.click&&this.$el.on("click",function(t){void 0===t.target.dataset.event&&this.model.owner.options.click(this.model,this)}.bind(this)),this.$el.find("[data-event].custom-event").on("click",function(t){t.stopPropagation(),$(t.target).closest(".dropdown-menu").toggle();var e=_.find(this.model.owner.options.events,{name:t.target.dataset.event});void 0!==e&&"function"==typeof e.callback&&e.callback(this.model)}.bind(this)),this.$el.find(".btn-group > .dropdown-toggle").on("click",function(t){t.stopPropagation(),$(this).next(".dropdown-menu").toggle()}),this.$el.find('[data-event="edit"]').on("click",function(t){t.stopPropagation(),$(t.target).closest(".dropdown-menu").toggle(),this.edit()}.bind(this)),this.edit=function(){$().gform($.extend(!0,{},{name:"modal",legend:'<i class="fa fa-pencil-square-o"></i> Edit',model:this.model},this.model.owner.options.gform||{})).on("saved",function(){"function"==typeof this.model.owner.options.edit&&this.model.owner.options.edit(this.model),this.update()},this)},this.$el.find('[data-event="mark"]').on("click",$.proxy(function(t){t.stopPropagation(),this.model.toggle(t.currentTarget.checked)},this)),this.$el.find("[data-moment]").each(function(t){$(this).html(moment.utc($(this).data("moment")).format($(this).data("format")))}),this.$el.find(".sparkline").each(function(){$(this).peity($(this).data("type"),{radius:$(this).data("radius")})})},this.setElement=function(t){return this.$el=$(t),this},this.model=t.model,this.model.on("check",this.update.bind(this)),this.$el=$("<tr>"),t.container&&t.container.append(this.$el),this.model.on("change",this.update,this),this.model.on("destroy",function(){this.$el.fadeOut("fast",function(){this.remove()}.bind(this))}.bind(this)),this.update()}
templates={events:'<div>\n<span class="hidden-xs">\n{{#options.hasDelete}}\n<a href="javascript:void(0);" data-event="delete_all" class="btn btn-danger {{^checked_count}}disabled{{/checked_count}}" style="margin-right:15px"><i class="fa fa-times"></i> Delete</a>\n{{/options.hasDelete}}\n<div class="btn-group"role="group" aria-label="...">\n\n    {{#options.hasEdit}}<a href="javascript:void(0);" data-event="edit_all" class="btn btn-primary {{^checked_count}}disabled{{/checked_count}}{{^multiEdit}}{{#multi_checked}}disabled{{/multi_checked}}{{/multiEdit}}" data-id="{{start}}id{{end}}"><i class="fa fa-pencil"></i> Edit</a>{{/options.hasEdit}}\n\n    {{#options.events}}\n      {{^global}}<a href="javascript:void(0);" data-event="{{name}}" class="custom-event btn btn-default {{^checked_count}}disabled{{/checked_count}}{{^multiEdit}}{{#multi_checked}}disabled{{/multi_checked}}{{/multiEdit}}" data-id="{{start}}id{{end}}">{{{label}}}</a>{{/global}}\n    {{/options.events}}\n\n</div>\n</span>\n<div class="btn-group visible-xs">\n  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n    <i class="fa fa-cogs"></i> <span class="caret"></span>\n  </button>\n  <ul class="dropdown-menu">\n      {{#options.hasEdit}}<li  class=" {{^checked_count}}disabled{{/checked_count}}{{^multiEdit}}{{#multi_checked}}disabled{{/multi_checked}}{{/multiEdit}}"><a href="javascript:void(0);" data-event="edit_all" data-id="{{start}}id{{end}}"><i class="fa fa-pencil"></i> Edit</a></li> {{/options.hasEdit}}\n\n      {{#options.events}}\n        {{^global}}<li class="{{^checked_count}}disabled{{/checked_count}}{{^multiEdit}}{{#multi_checked}}disabled{{/multi_checked}}{{/multiEdit}}"><a href="javascript:void(0);" data-event="{{name}}" class="custom-event" data-id="{{start}}id{{end}}">{{{label}}}</a></li>{{/global}}\n      {{/options.events}}\n      {{#options.hasDelete}}\n        <li role="separator" class="divider"></li>\n        <li class=" {{^checked_count}}disabled{{/checked_count}}"><a href="javascript:void(0);" data-event="delete_all" style="margin-right:15px"><i class="fa fa-times"></i> Delete</a></li>\n      {{/options.hasDelete}}\n  </ul>\n</div>\n</div>\n',count:'\t\t{{#checked_count}}<h5 class="range label label-info checked_count" style="margin:7px 15px;">{{checked_count}} item(s) selected</h5>{{/checked_count}}',mobile_head:'\n<div style="clear:both;">\n\n  {{#options.sort}}\n\n  <div class="row" style="margin-bottom:10px">\n\n    <div class="col-xs-6">\n    {{#options.filter}}\n\n      <div name="reset-search" style="position:relative" class="btn btn-default" data-toggle="tooltip" data-placement="left" title="Clear Filters">\n        <i class="fa fa-filter"></i>\n        <i class="fa fa-times text-danger" style="position: absolute;right: 5px;"></i>\n      </div>    \n\n    <div class="btn btn-info filterForm">Filter</div>\n  {{/options.filter}}\n    </div>\n    <div class="col-xs-6">\n    \t\t{{#options.search}}<input type="text" name="search" class="form-control" style="" placeholder="Search">{{/options.search}}\n        </div>\n    </div>\n    <div class="input-group">\n      <span class="" style="display: table-cell;width: 1%;white-space: nowrap;vertical-align: middle;padding-right:5px">\n        <button class="btn btn-default reverse" type="button" tabindex="-1"><i class="fa fa-sort text-muted"></i></button>\n      </span>\n        <select class="form-control sortBy">\n          <option value=true>None</option>\n          {{#items}}\n            {{#visible}}\n              <option value="{{id}}">{{label}}</option>\n            {{/visible}}\n          {{/items}}\n        <select>\n    </div>\n  {{/options.sort}}\n\n</div>\n',mobile_row:'<tr><td colspan="100%" class="filterable">\t\t\n{{#options.hasActions}}\n<div data-event="mark" style="text-align:left;padding:0;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;">\n<span class="text-muted fa {{start}}#checked{{end}}fa-check-square-o{{start}}/checked{{end}} {{start}}^checked{{end}}fa-square-o{{start}}/checked{{end}}" style="margin:6px; cursor:pointer;font-size:24px"></span>\n</div>\n  {{/options.hasActions}}\n<div>\n{{#items}}\n{{#visible}}{{#isEnabled}}<div class="row" style="min-width:85px"><span class="col-sm-3"><b>{{label}}</b></span><span class="col-sm-9 col-xs-12">{{{name}}}</span></div>{{/isEnabled}}{{/visible}}\n{{/items}}\n</div>\n</td></tr>',mobile_table:'<div class="well table-well">\n<div style="height:40px;">\n  <div name="events" class=" pull-left" style="margin-bottom:10px;width:62%" ></div>\n\n  <input type="file" class="csvFileInput" accept=".csv" style="display:none">\n\n  <div class="hiddenForm" style="display:none"></div>\n  <div class="btn-group pull-right" style="margin-bottom:10px" role="group" aria-label="...">\n    {{#showAdd}}\n    <div data-event="add" class="btn btn-success"><i class="fa fa-pencil-square-o"></i> New</div>\n    {{/showAdd}}\t\n\n    {{#options.events}}\n      {{#global}}<div class="btn btn-default custom-event" data-event="{{name}}" data-id="{{start}}id{{end}}">{{{label}}}</div>{{/global}}\n    {{/options.events}}\n    {{#options.download}}\n    <div class="btn btn-default hidden-xs" name="bt-download" data-toggle="tooltip" data-placement="left" title="Download"><i class="fa fa-download"></i></div>\n    {{/options.download}}\n    {{#options.upload}}\n    <div class="btn btn-default hidden-xs" name="bt-upload" data-toggle="tooltip" data-placement="left" title="Upload"><i class="fa fa-upload"></i></div>\n    {{/options.upload}}\n\n\n    {{#options.columns}}\n    <div class="btn-group columnEnables" data-toggle="tooltip" data-placement="left" title="Display Columns">\n      <button class="btn btn-default dropdown-toggle" type="button" id="enables_{{options.id}}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">\n        <i class="fa fa-list"></i>\n        <span class="caret"></span>\n      </button>\n      <ul class="dropdown-menu pull-right" style="padding-top:10px" aria-labelledby="enables_{{options.id}}">\n        {{#items}}\n        {{#visible}}\n        <li><label data-field="{{id}}" style="width:100%;font-weight:normal"><input type="checkbox" {{#isEnabled}}checked="checked"{{/isEnabled}} style="margin: 5px 0 5px 15px;"> {{label}}</label></li>\n        {{/visible}}\n        {{/items}}\n      </ul>\n    </div>\n    {{/options.columns}}\n\n  </div>\n\n\n</div>\t\n    {{>mobile_head}}\n\n\n{{#options.hasActions}}\n<div style="padding: 16px 0 0 15px;"><i data-event="select_all" class="fa fa-2x fa-square-o"></i></div>\n{{/options.hasActions}}\n\n<div class="table-container" style="width:100%;overflow:auto">\n\n<div style="min-height:100px">\n  <table class="table {{^options.noborder}}table-bordered{{/options.noborder}} table-striped table-hover dataTable" style="margin-bottom:0px">\n    <tbody class="list-group">\n      <tr><td>\n        <div class="alert alert-info" role="alert">You have no items.</div>\n      </td></tr>\n    </tbody>\n\n  </table>\n</div>\n\n</div>\n<div class="paginate-footer" style="overflow:hidden;margin-top:10px"></div>\n</div>',table:'<div class="well table-well">\n<div style="overflow:hidden">\n  <div name="events" class=" pull-left" style="margin-bottom:10px;width:62%" ></div>\n\n  <input type="file" class="csvFileInput" accept=".csv" style="display:none">\n\n  <div class="hiddenForm" style="display:none"></div>\n  <div class="btn-group pull-right" style="margin-bottom:10px;margin-left:10px" role="group" aria-label="...">\n    {{#showAdd}}\n    <div data-event="add" class="btn btn-success"><i class="fa fa-pencil-square-o"></i> New</div>\n    {{/showAdd}}\t\t\n    {{#options.events}}\n      {{#global}}<div class="btn btn-default custom-event {{global}}" data-event="{{name}}" data-id="{{start}}id{{end}}">{{{label}}}</div>{{/global}}\n    {{/options.events}}\n\n  </div>\n \n</div>\t\n<div>\n\n  <div class="btn-group pull-right" style="margin-bottom:10px;margin-left:10px" role="group" aria-label="...">\n\n    {{#options.download}}\n    <div class="btn btn-default hidden-xs" name="bt-download" data-toggle="tooltip" data-placement="left" title="Download"><i class="fa fa-download"></i></div>\n    {{/options.download}}\n    {{#options.upload}}\n    <div class="btn btn-default hidden-xs" name="bt-upload" data-toggle="tooltip" data-placement="left" title="Upload"><i class="fa fa-upload"></i></div>\n    {{/options.upload}}\n\n\n    {{#options.columns}}\n    <div class="btn-group columnEnables" data-toggle="tooltip" data-placement="left" title="Display Columns">\n      <button class="btn btn-default dropdown-toggle" type="button" id="enables_{{options.id}}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">\n        <i class="fa fa-list"></i>\n        <span class="caret"></span>\n      </button>\n      <ul class="dropdown-menu pull-right" style="padding-top:10px;padding-left:10px" aria-labelledby="enables_{{options.id}}">\n        {{#items}}\n        {{#visible}}\n        <li><label data-field="{{id}}" style="width:100%;font-weight:normal"><input type="checkbox" {{#isEnabled}}checked="checked"{{/isEnabled}}> {{label}}</label></li>\n        {{/visible}}\n        {{/items}}\n      </ul>\n    </div>\n    {{/options.columns}}\n  </div>\n  {{#options.search}}<input type="text" name="search" class="form-control pull-right" style="max-width:300px; margin-bottom:10px" placeholder="Search">{{/options.search}}\n\n  <span name="count"></span>\n</div>\n\n{{^options.autoSize}}\n<div class="paginate-footer hidden-xs" style="overflow:hidden;margin-top:10px;clear:both"></div>\n{{/options.autoSize}}\n\n<div class="table-container" style="width:100%;overflow:auto">\n{{#options.autoSize}}\n<table class="table {{^options.noborder}}table-bordered{{/options.noborder}}" style="margin-bottom:0px">\n<thead class="head">\n{{>table_head}}\n</thead>\n</table>\n{{/options.autoSize}}\n\n\n<div style="min-height:100px">\n  <table class="table {{^options.noborder}}table-bordered{{/options.noborder}} table-striped table-hover dataTable" style="margin-bottom:0px;{{#options.autoSize}}margin-top: -19px;{{/options.autoSize}}">\n    {{^options.autoSize}}\n    <thead class="head">\n    {{>table_head}}\n    </thead>\n    {{/options.autoSize}}\n{{#options.autoSize}}\n    <thead>\n          <tr  class="list-group-row">\n              {{#options.hasActions}}\n  <th style="width:60px" class="select-column"></th>\n  {{/options.hasActions}}\n        {{#items}}\n  {{#visible}}\n<th  style="min-width:85px">\n  {{/visible}}\n  {{/items}}\n  </tr>\n  </thead>\n{{/options.autoSize}}\n    <tbody class="list-group">\n      <tr><td>\n        <div class="alert alert-info" role="alert">You have no items.</div>\n      </td></tr>\n    </tbody>\n\n  </table>\n</div>\n\n</div>\n<div class="paginate-footer" style="overflow:hidden;margin-top:10px"></div>\n</div>',table_footer:'<div>\n{{#multiPage}}\n<nav class="pull-right" style="margin-left: 10px;">\n{{#size}}\n  <ul class="pagination" style="margin:0">\n    {{^isFirst}}\n    {{^showFirst}}<li class="pagination-first"><a data-page="1" href="javascript:void(0);" aria-label="First"><span aria-hidden="true">&laquo;</span></a></li>{{/showFirst}}\n    <li><a data-page="dec" href="javascript:void(0);" aria-label="Previous"><span aria-hidden="true">&lsaquo;</span></a></li>\n    {{/isFirst}}\n    {{#pages}}\n      <li class="{{active}}"><a data-page="{{name}}" href="javascript:void(0);">{{name}}</a></li>\n    {{/pages}}\n    {{^isLast}}\n    <li><a data-page="inc" href="javascript:void(0);" aria-label="Next"><span aria-hidden="true">&rsaquo;</span></a></li>\n    {{^showLast}}<li class="pagination-last"><a data-page="" href="javascript:void(0);" aria-label="Last"><span aria-hidden="true">&raquo;</span></a></li>{{/showLast}}\n    {{/isLast}}\n\n  </ul>\n{{/size}}\n</nav>\n\n{{/multiPage}}\t\n<h5 class="range badge {{^size}}alert-danger{{/size}} pull-left" style="margin-right:15px;">{{#size}}Showing {{first}} to {{last}} of {{size}} results{{/size}}{{^size}}No matching results{{/size}}</h5>\n  {{#entries.length}}\n  <span class="pull-left">\n    <select class="form-control" style="display:inline-block;width:auto;min-width:50px" name="count">\n    <option value="10000">All</option>\n    {{#entries}}\n    <option value="{{value}}" {{#selected}}selected="selected"{{/selected}}>{{value}}</option>\n    {{/entries}}\n\n    </select>\n    <span class="hidden-xs">results per page</span>\n  </span>\n  {{/entries.length}}\n</div>',table_head:'  <tr style="cursor:pointer" class="noselect table-sort">\n{{#options.hasActions}}\n<th style="width: 60px;min-width:60px;padding: 0 0 0 20px;" class="select-column"><i data-event="select_all" class="fa fa-2x fa-square-o"></i></th>\n{{/options.hasActions}}\n\n{{#items}}\n{{#visible}}\n<th data-sort="{{cname}}"><h6 style="margin: 2px;font-size:13px;white-space: nowrap">{{#options.sort}}<i class="fa fa-sort text-muted"></i> {{/options.sort}}{{label}}</h6></th>\n{{/visible}}\n{{/items}}\n</tr>\n{{#options.filter}}\n<tr class="filter">\n{{#options.hasActions}}<td>\n<div name="reset-search" style="position:relative" class="btn" data-toggle="tooltip" data-placement="left" title="Clear Filters">\n  <i class="fa fa-filter"></i>\n  <i class="fa fa-times text-danger" style="position: absolute;right: 5px;"></i>\n</div>\n</td>{{/options.hasActions}}\n\n{{#items}}\n{{#visible}}\n<td data-inline="{{cname}}" style="min-width:85px" id="{{id}}"></td>\n{{/visible}}\n{{/items}}\n</tr>\n{{/options.filter}}',table_row:'<tr class="filterable">\t\t\n{{#options.hasActions}}\n\n<td data-event="mark" style="width: 60px;min-width:60px;text-align:left;padding:0;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;">\n  <span class="text-muted fa {{start}}#checked{{end}}fa-check-square-o{{start}}/checked{{end}} {{start}}^checked{{end}}fa-square-o{{start}}/checked{{end}}" style="margin:6px 0 6px 20px; cursor:pointer;font-size:24px"></span>\n   </td>\n\n  {{/options.hasActions}}\n{{#items}}\n{{#visible}}{{#isEnabled}}<td style="min-width:85px">{{{name}}}</td>{{/isEnabled}}{{/visible}}\n{{/items}}\n</tr>'};
